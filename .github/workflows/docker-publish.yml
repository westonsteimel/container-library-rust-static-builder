on: 
  push:
    branches:
      - main
  schedule:
    - cron: '0 1 * * *'
name: Build and publish to DockerHub
env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  DOCKER_REGISTRY: 'docker.io'
  DOCKER_REPOSITORY: 'rust-static-builder'
jobs:
  stable:
    name: stable
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Build and Publish stable to DockerHub
        run: |
          export DOCKER_BUILD_CONTEXT="stable" 
          docker build --tag get-version --platform "linux/amd64" --build-arg TARGET="x86_64-unknown-linux-musl" "${DOCKER_BUILD_CONTEXT}"
          VERSION_STRING=`docker run --rm --entrypoint "rustc" get-version --version`
          pattern='^rustc (.*) \(.*$'
          [[ $VERSION_STRING =~ $pattern ]] # $pat must be unquoted
          echo "${BASH_REMATCH[1]}"
          export DOCKER_IMAGE_VERSION="${BASH_REMATCH[1]}"
          DATE_TAG=`date --utc --rfc-3339=date`
          export DOCKER_TAGS="stable,latest,${DOCKER_IMAGE_VERSION},stable-${DATE_TAG}"
          ./scripts/publish.sh
  nightly:
    name: nightly
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Build and Publish nightly to DockerHub
        run: |
            export DOCKER_BUILD_CONTEXT="nightly"
            docker build --tag get-version --platform "linux/amd64" --build-arg TARGET="x86_64-unknown-linux-musl" "${DOCKER_BUILD_CONTEXT}"
            VERSION_STRING=`docker run --rm --entrypoint "rustc" get-version --version`
            pattern='^rustc (.*) \(.*$'
            [[ $VERSION_STRING =~ $pattern ]] # $pat must be unquoted
            echo "${BASH_REMATCH[1]}"
            export DOCKER_IMAGE_VERSION="${BASH_REMATCH[1]}"
            DATE_TAG=`date --utc --rfc-3339=date`
            export DOCKER_TAGS="nightly,${DOCKER_IMAGE_VERSION},nightly-${DATE_TAG}"
            ./scripts/publish.sh

